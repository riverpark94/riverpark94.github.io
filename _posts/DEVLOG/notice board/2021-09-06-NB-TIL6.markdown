---
layout: post
title: '[ê²Œì‹œíŒ ë§Œë“¤ê¸°] TIL 6. JWT, Logout'
date: 2021-09-06 21:18:44 +0900
subtitle: 'Wiki'
categories: DEVLOG
tags: Notice_Board
comments: true
toc: true
---

> 1. ë¼ìš°í„° ë¶„ë¦¬
> 2. Sequelize
> 3. Join API
>    3.1. controllers
>    3.2. middlewares

<br>

ğŸ˜€ [Notice Board ë ˆíŒŒì§€í† ë¦¬](https://github.com/riverpark94/Notice_Board)ğŸ˜€ <br>Stack : Javascript, express, nodejs, sequelize
{: .notice--warning}

<br>

â˜… : ì´ë²ˆ ê³¼ì •ì„ í†µí•´ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ì§„ íŒŒì¼

â˜† : ì´ë²ˆ ê³¼ì •ì„ í†µí•´ì„œ ìˆ˜ì •ëœ íŒŒì¼

```
/
â”œâ”€â”€ ğŸ“/server
â”‚   â”œâ”€â”€ ğŸ“„README.md                     # Notice_Board README.md íŒŒì¼
â”‚   â”œâ”€â”€ ğŸ“„index.js                      # node.jsë¡œ ì‘ì„±ëœ ì›¹ ì„œë²„ ì§„ì…ì 
â”‚   â”œâ”€â”€ ğŸ“„package.json
â”‚   â”œâ”€â”€ ğŸ“„package-lock.json
â”‚   â”œâ”€â”€ ğŸ“„.gitignore                    # node_modules, env ë“± í¬í•¨ë˜ì§€ ì•Šê²Œ ì„¤ì •ìš”ë§
â”‚   â”œâ”€â”€ ğŸ“/config                       # í™˜ê²½ë³€ìˆ˜
â”‚   â”‚    â”œâ”€â”€ ğŸ“„config.js        
â”‚   â”‚    â””â”€â”€ ğŸ“„jwt.js                   # jwt ê´€ë ¨ í™˜ê²½ë³€ìˆ˜
â”‚   â”œâ”€â”€ ğŸ“/controllers                  # ê¸°ëŠ¥ API
â”‚   â”‚    â”œâ”€â”€ ğŸ“„index.js        
â”‚   â”‚    â”œâ”€â”€ ğŸ“User                     # ìœ ì €ê´€ë ¨ API
â”‚   â”‚         â”œâ”€â”€ ğŸ“„â˜† index.js 
â”‚   â”‚         â”œâ”€â”€ ğŸ“„join.js             # join API
â”‚   â”‚         â”œâ”€â”€ ğŸ“„login.js            # login API
â”‚   â”‚         â””â”€â”€ ğŸ“„â˜… logout.js        # logout API
â”‚   â”œâ”€â”€ ğŸ“/middlewares
â”‚   â”‚    â”œâ”€â”€ ğŸ“„CheckEmailForm.js        # email ì–‘ì‹ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” middleware
â”‚   â”‚    â”œâ”€â”€ ğŸ“„CheckPassword.js         # password ì¡°ê±´ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” middleware      
â”‚   â”‚    â””â”€â”€ ğŸ“„â˜… checkToken.js         # â˜… JWT ê²€ì¦ middleware
â”‚   â”œâ”€â”€ ğŸ“/migrations 
â”‚   â”‚    â”œâ”€â”€ ğŸ“„20210819052749-create-users.js
â”‚   â”‚    â””â”€â”€ ğŸ“„20210819065842-add-column-in-usersTable.js          
â”‚   â”œâ”€â”€ ğŸ“/models                       # DB ëª¨ë¸ íŒŒì¼
â”‚   â”‚    â”œâ”€â”€ ğŸ“„index.js
â”‚   â”‚    â””â”€â”€ ğŸ“„users.js
â”‚   â”œâ”€â”€ ğŸ“/routes
â”‚        â””â”€â”€ ğŸ“„â˜† index.js               # ë¶„ê¸° íŒŒì¼
â”‚   
```

<br>

**/controllers/Users/logout.js**

```js
const { Users } = require('../../models');

module.exports = {
  post : async (req, res) =>{
    res.clearCookie("sid");
    res.status(205).send("logged out success");
  }
}
```

**/middlewares/checkToken.js**

```js
const jwt = require('jsonwebtoken');
let secretObj = require("../config/jwt");

const checkToken = (req, res, next) => {
  const cookie = req.headers.cookie;
  const secret = secretObj.secret;

  if (!cookie){
    res.status(401).json({
      success:false,
      message:'unvaild token'
    })
  }

  const token = cookie.split("=")[1];
  const check = new Promise((resolve, reject) =>{
    jwt.verify(token, secret, (err, decoded) => {
      if (err) reject(err);
      resolve(decoded);
    })
  })

  check.then(user => {
    req.user = user;
    next();
  }).catch(err => {
      res.status(401).json({
        success: false,
        message: err
      })
  })
}

module.exports = checkToken;
```

**/routes/index.js**

```js
const express = require('express');
const router = express.Router();

const checkToken = require('../middlewares/checkToken');
const { userController, myPageController } = require('../controllers');


router.get('/', (req, res) => {
  res.send("Site access success");
});

router.post('/user/join', userController.join.post);
router.post('/user/login', userController.login.post);

router.use(checkToken);
router.post('/user/logout', userController.logout.post);

module.exports = router;
```

<br>

# 1. controllers

**/controllers/Users/logout.js**

```js
const { Users } = require('../../models');

module.exports = {
  post : async (req, res) =>{
    res.clearCookie("sid");
    res.status(205).send("logged out success");
  }
}
```

cookieparser ë˜í•œ bodyparserì™€ ë”ë¶ˆì–´ì„œ Express ë‚´ë¶€ì— ë¹ŒíŠ¸ì¸ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ëª¨ë“ˆ ì‚¬ìš© ì—†ì´ `res.cookie()`ì™€ `res.clearCookie()`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì–´ì œ tokenì„ cookieì— ë„£ì–´ì£¼ì—ˆê¸° ë•Œë¬¸ì—, ë¡œê·¸ì•„ì›ƒì´ ì´ ê¸°ë¡ì„ ì—†ì• ì•¼ í•œë‹¤. ë•Œë¬¸ì— ì§€ì •í•œ ì¿ í‚¤ë¥¼ `clearCookie()`ë¥¼ ì´ìš©í–ˆë‹¤. tokenì„ ì§€ìš¸ ëª©ì ì´ê¸° ë•Œë¬¸ì— ì–´ì œ tokenì´ ë“¤ì–´ê°ˆ ì¿ í‚¤ì´ë¦„ì¸ "sid"ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ í•˜ì˜€ë‹¤.

<br>

# 2. JWT í† í° ê²€ì¦

**/middlewares/checkToken.js**

```js
const jwt = require('jsonwebtoken');
let secretObj = require("../config/jwt");

const checkToken = (req, res, next) => {
  const cookie = req.headers.cookie;
  const secret = secretObj.secret;

  if (!cookie){
    res.status(401).json({
      success:false,
      message:'unvaild token'
    })
  }

  const token = cookie.split("=")[1];
  const check = new Promise((resolve, reject) =>{
    jwt.verify(token, secret, (err, decoded) => {
      if (err) reject(err);
      resolve(decoded);
    })
  })

  check.then(user => {
    req.user = user;
    next();
  }).catch(err => {
      res.status(401).json({
        success: false,
        message: err
      })
  })
}

module.exports = checkToken;
```

`jwt.verify()`ë¼ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ê²€ì¦í•œë‹¤. `verify` í•¨ìˆ˜ëŠ” ì¸ìë¡œëŠ” ë°œê¸‰ë°›ì€ token, ìƒì„±í•  ë•Œ ì‚¬ìš©í•œ ë¹„ë°€í‚¤, [ì˜µì…˜]ì´ ëœë‹¤. ì˜µì…˜ì€ ìˆì–´ë„ ê·¸ë§Œ, ì—†ì–´ë„ ê·¸ë§Œì´ë‹¤. ê²€ì¦í•˜ë©´ í† í°ì˜ êµ¬ì—­ ì¤‘ PayLoadê°€ Decodedëœë‹¤. ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë¡œê·¸ì¸ëœ userì˜ email ê°’ì„ ë¶ˆëŸ¬ì˜¨ë‹¤.

ë¹„ë°€í‚¤ê°€ í‹€ë¦¬ê±°ë‚˜, ë§Œë£Œ ì‹œê°„ì´ ì§€ë‚˜ë©´ errê°€ ë°œìƒí•´ catchë¡œ ë„˜ì–´ê°„ë‹¤.

**/routes/index.js**

```js
const express = require('express');
const router = express.Router();

const checkToken = require('../middlewares/checkToken');
const { userController, myPageController } = require('../controllers');


router.get('/', (req, res) => {
  res.send("Site access success");
});

router.post('/user/join', userController.join.post);
router.post('/user/login', userController.login.post);

router.use(checkToken);
router.post('/user/logout', userController.logout.post);

module.exports = router;
```

ì´ì œ ì´ê²ƒì„ ì ìš©í•˜ë ¤ë©´ í† í° ì¸ì¦ì„ ë¯¸ë“¤ì›¨ì–´ì²˜ëŸ¼ ë¶ˆëŸ¬ì˜¤ê³ , `router.use()`ì˜ ì¸ìë¡œ ë„£ì–´ì£¼ë©´ ëœë‹¤. ( `app.use()`ì²˜ëŸ¼) ê·¸ë¦¬ê³  ì´ê²ƒì€ ì¸ì¦ì´ í•„ìš”í•œ ë¼ìš°í„° ìœ„ì— ìœ„ì¹˜í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì•ìœ¼ë¡œ ë¼ìš°í„°ëŠ” `router.use(checkToken);`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ ìœ„ì— ì‘ì„±ëœ ë¼ìš°í„°ëŠ” ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ê¸°ëŠ¥(ì¸ì¦ì´ í•„ìš” ì—†ëŠ” ê¸°ëŠ¥), ê·¸ ì•„ë˜ì— ì‘ì„±ëœ ë¼ìš°í„°ëŠ” ë¡œê·¸ì¸ì„ í•´ì•¼ í•˜ëŠ” ê¸°ëŠ¥(ì¸ì¦ì´ í•„ìš”í•œ ê¸°ëŠ¥)ì´ ë  ê²ƒì´ë‹¤.

