---
layout: post
title: '[ê²Œì‹œíŒ ë§Œë“¤ê¸°] TIL 8. CreateBoard'
date: 2021-09-10 21:18:44 +0900
subtitle: 'Wiki'
categories: DEVLOG
tags: Notice_Board
comments: true
toc: true
---

> 1. associate (1:N)
> 
> 2. MySQL í•œê¸€ ê¹¨ì§ ë¬¸ì œ(utf8)

<br>

ğŸ˜€ [Notice Board ë ˆíŒŒì§€í† ë¦¬](https://github.com/riverpark94/Notice_Board)ğŸ˜€ <br>Stack : Javascript, express, nodejs, sequelize
{: .notice--warning}

<br>

â˜… : ì´ë²ˆ ê³¼ì •ì„ í†µí•´ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ì§„ íŒŒì¼

â˜† : ì´ë²ˆ ê³¼ì •ì„ í†µí•´ì„œ ìˆ˜ì •ëœ íŒŒì¼

```
/
â”œâ”€â”€ ğŸ“/server
â”‚   â”œâ”€â”€ ğŸ“„README.md                     # Notice_Board README.md íŒŒì¼
â”‚   â”œâ”€â”€ ğŸ“„index.js                      # node.jsë¡œ ì‘ì„±ëœ ì›¹ ì„œë²„ ì§„ì…ì 
â”‚   â”œâ”€â”€ ğŸ“„package.json
â”‚   â”œâ”€â”€ ğŸ“„package-lock.json
â”‚   â”œâ”€â”€ ğŸ“„.gitignore                    # node_modules, env ë“± í¬í•¨ë˜ì§€ ì•Šê²Œ ì„¤ì •ìš”ë§
â”‚   â”œâ”€â”€ ğŸ“/config                       # í™˜ê²½ë³€ìˆ˜
â”‚   â”‚    â”œâ”€â”€ ğŸ“„config.js        
â”‚   â”‚    â””â”€â”€ ğŸ“„jwt.js                   # jwt ê´€ë ¨ í™˜ê²½ë³€ìˆ˜
â”‚   â”œâ”€â”€ ğŸ“/controllers                  # ê¸°ëŠ¥ API
â”‚   â”‚    â”œâ”€â”€ ğŸ“„â˜† index.js        
â”‚   â”‚    â”œâ”€â”€ ğŸ“User                     # ìœ ì €ê´€ë ¨ API
â”‚   â”‚    â”‚    â”œâ”€â”€ ğŸ“„index.js 
â”‚   â”‚    â”‚    â”œâ”€â”€ ğŸ“„join.js             # join API
â”‚   â”‚    â”‚    â”œâ”€â”€ ğŸ“„login.js            # login API
â”‚   â”‚    â”‚    â””â”€â”€ ğŸ“„logout.js           # logout API
â”‚   â”‚    â”œâ”€â”€ ğŸ“MyPage                   # ë§ˆì´í˜ì´ì§€ API
â”‚   â”‚    â”‚    â”œâ”€â”€ ğŸ“„index.js 
â”‚   â”‚    â”‚    â”œâ”€â”€ ğŸ“„myPage.js            # myPage API
â”‚   â”‚    â”‚    â””â”€â”€ ğŸ“„editUserInfo.js      # editUserInfo API
â”‚   â”‚    â””â”€â”€ ğŸ“Boards                   # ê²Œì‹œíŒ API
â”‚   â”‚         â”œâ”€â”€ ğŸ“„â˜… index.js 
â”‚   â”‚         â””â”€â”€ ğŸ“„â˜… writeBoard.js     # writeBoard API
â”‚   â”œâ”€â”€ ğŸ“/middlewares
â”‚   â”‚    â”œâ”€â”€ ğŸ“„CheckEmailForm.js        # email ì–‘ì‹ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” middleware
â”‚   â”‚    â”œâ”€â”€ ğŸ“„CheckPassword.js         # password ì¡°ê±´ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” middleware      
â”‚   â”‚    â””â”€â”€ ğŸ“„checkToken.js            # JWT ê²€ì¦ middleware
â”‚   â”œâ”€â”€ ğŸ“/migrations 
â”‚   â”‚    â”œâ”€â”€ ğŸ“„20210819052749-create-users.js
â”‚   â”‚    â”œâ”€â”€ ğŸ“„20210819065842-add-column-in-usersTable.js   
â”‚   â”‚    â”œâ”€â”€ ğŸ“„â˜… 20210910065541-create-boards.js
â”‚   â”‚    â””â”€â”€ ğŸ“„â˜… 20210910070528-fk-Boards.js         
â”‚   â”œâ”€â”€ ğŸ“/models                       # DB ëª¨ë¸ íŒŒì¼
â”‚   â”‚    â”œâ”€â”€ ğŸ“„index.js
â”‚   â”‚    â”œâ”€â”€ ğŸ“„users.js
â”‚   â”‚    â””â”€â”€ ğŸ“„â˜… boards.js
â”‚   â”œâ”€â”€ ğŸ“/routes
â”‚        â””â”€â”€ ğŸ“„â˜† index.js               # ë¶„ê¸° íŒŒì¼
â”‚   
```

<br>

**/controllers/Boards/writeBoard.js**

```js
  
const { Users } = require('../../models');
const { Boards } = require('../../models');

module.exports = {
  post : async (req, res) =>{
    const { title, content } = req.body;

    if(!title||!content) {
      if(!title && !content) {
        res.status(403).send("Please write down the title and content.");
      }
      else if(!title) {
        res.status(403).send("Please write down the title.");
      }
      else if(!content) {
        res.status(403).send("Please write down the content.");
      }
    }
    else{
      const email = req.user;
      const userInfo =await Users.findOne({
        where : {email}
      })
      const dbId = userInfo.dataValues.id;
      const dbNickname = userInfo.dataValues.nickname;

      await Boards.create({
        userId : dbId,
        title : title,
        content : content,
        like : 0
      })
      .then (data => {
        res.status(200).json({
          userId: data.userId,
          user : {
            nickname: dbNickname,
          },
          title : data.title,
          content : data.content,
          like :data.like
        });
      })
    }
  }
}
```

**/migrations/20210910065541-create-boards.js**

```js
'use strict';
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('Boards', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER
      },
      userId: {
        type: Sequelize.INTEGER,
        references: {
          model: 'Users',
          key: 'id',
          as: 'userId'
        }
      },
      title: {
        type: Sequelize.STRING
      },
      content: {
        type: Sequelize.STRING
      },
      like: {
        type: Sequelize.INTEGER,
        defaultValue:0
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE
      }
    },{
    charset: 'utf8',
    collate: 'utf8_unicode_ci',
    underscored: true,
 
    freezeTableName: true,
 
    tableName: 'Boards'
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Boards');
  }
};
```

**/migrations/20210910070528-fk-Boards.js**

```js
'use strict';
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn("Boards", "userId");
    await queryInterface.addColumn("Boards", "userId", {
      type: Sequelize.INTEGER,
    });
    await queryInterface.addConstraint("Boards", {
      fields: ["userId"],
      type: "foreign key",
      name: "User_write_Post_fk",
      references: {
        table: "Users",
        field: "id",
      },
      onDelete: "cascade",
      onUpdate: "cascade",
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn("Boards", "userId");
  },
};
```

<br>

ê¸°ëŠ¥ìœ¼ë¡œëŠ” join APIì™€ ë³„ë°˜ ë‹¤ë¥¼ê²Œ ì—†ìœ¼ë¯€ë¡œ controllersì— ëŒ€í•œ ì„¤ëª…ì€ ìƒëµí•˜ê³ , 1:1 ê´€ê³„ ì„¤ì •ê³¼ í•œê¸€ ê¹¨ì§ ë¬¸ì œì— ëŒ€í•´ì„œ ê¸°ë¡í•˜ê³ ì í•œë‹¤.

<br>

# 1. associate (1:N)

ëª¨ë¸ ê°„ì˜ ê´€ê³„ì—ëŠ” 1:1, 1:N, N:M ê´€ê³„ê°€ ìˆë‹¤. ì´ë²ˆì— ì •ì˜í•œ 1:N ê´€ê³„ëŠ” `hasMany()`ì™€ `belongsTo()`ë¼ëŠ” ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•œë‹¤. `belongsTo()`ëŠ” ì˜ˆë¥¼ ë“¤ë©´ ì„ ìˆ˜ê°€ í•˜ë‚˜ì˜ íŒ€ì„ ê°–ê²Œ ë˜ëŠ” ê²ƒì²˜ëŸ¼ ê´€ê³„ë¥¼ í˜•ì„±ë˜ê³ , `hasMany()`ëŠ” ë°˜ëŒ€ë¡œ í•˜ë‚˜ì˜ íŒ€ì´ ì—¬ëŸ¬ ëª…ì˜ ì„ ìˆ˜ë¥¼ ê°–ê²Œ ë˜ëŠ” ê²ƒ ê°™ì€ ê´€ê³„ë¥¼ í˜•ì„±í•œë‹¤.

```js
this.belongsTo(models.Users, {foreignKey: "userId"}); // boards.js ì˜ associate ë¶€ë¶„ì— ë“¤ì–´ê°€ëŠ” ì½”ë“œ
this.hasMany(models.Boards, {foreignKey: "userId"}); // users.js ì˜ associate ë¶€ë¶„ì— ë“¤ì–´ê°€ëŠ” ì½”ë“œs
```

ë ˆí¼ëŸ°ìŠ¤ ìƒì—ì„œëŠ” ìœ„ì²˜ëŸ¼ ì½”ë“œë¥¼ ê° JSíŒŒì¼ì— ì¶”ê°€í•˜ë©´ `Boards.js`ì— `userId`ê°€ ìƒê¸°ê³  1:Nê´€ê³„ê°€ ë§Œë“¤ì–´ì§„ë‹¤ëŠ”ë°â€¦. ë‚˜ëŠ” ê·¸ê²Œ ì˜ ì•ˆ ë˜ëŠ” ê²ƒ ê°™ì•„ì„œ ë‹¤ë¥¸ ë°©ë²•ì„ ë” ì‚¬ìš©í–ˆë‹¤.  

```
sequelize migration:generate fk-Boards
```

ì™¸ë˜í‚¤ë¥¼ ì–´ë–»ê²Œ ì„¤ì •í–ˆê³  Users í…Œì´ë¸”ì˜ ì–´ë–¤ ì¹¼ëŸ¼ê³¼ ì—°ê²°í–ˆëŠ”ì§€ë§Œì„ ë³¼ ìˆ˜ ìˆë‹¤ëŠ” ì ê³¼ ë” ìƒì„¸í•˜ê²Œ ì¡°ê±´ë“¤ì„ ë„£ì„ ìˆ˜ ìˆë‹¤ëŠ” ì ì—ì„œ ìœ„ì™€ ê°™ì€ ëª…ë ¹ì–´ë¡œ íŒŒì¼ì„ ë§Œë“¤ê³  ì½”ë“œë¥¼ ì¶”ê°€í•´ì¤¬ë‹¤.

**/migrations/20210910070528-fk-Boards.js**

```js
'use strict';
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn("Boards", "userId");
    await queryInterface.addColumn("Boards", "userId", {
      type: Sequelize.INTEGER,
    });
    await queryInterface.addConstraint("Boards", {
      fields: ["userId"],
      type: "foreign key",
      name: "User_write_Post_fk",
      references: {
        table: "Users",
        field: "id",
      },
      onDelete: "cascade",
      onUpdate: "cascade",
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn("Boards", "userId");
  },
};
```

`queryInterface`ì—ëŠ” ì—¬ëŸ¬ê°œì˜ ë©”ì†Œë“œê°€ ìˆë‹¤. `removeColumn()`ì€ ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ `userId`ë¥¼ ì‚­ì œí•˜ëŠ” ë©”ì†Œë“œê³ , `addColumn()`ì´ë¼ëŠ” ë©”ì†Œë“œëŠ” ë‹¤ì‹œ `userId`ë¥¼ ë§Œë“ ë‹¤. ê·¸ë¦¬ê³  `addConstraint()`ë¡œ ì™¸ë˜í‚¤ì— ëŒ€í•œ ì„¤ì •ì„ ë„£ì–´ì¤€ë‹¤.

```
public async addConstraint(tableName, [fields, type, name, defaultValue, where, references.table, references.field]):
```

ìœ„ëŠ” `addConstraint()`ì˜ ì˜ˆì‹œì´ë‹¤. ì´ ì¤‘ì—ì„œ `tableName`ì„ ì œì™¸í•˜ë©´, ì •ë¶€ ìˆì–´ë„ ê·¸ë§Œ, ì—†ì–´ë„ ê·¸ë§Œì¸ ì˜µì…˜ì´ë‹¤ë§Œ... ì˜µì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë”±íˆ ì“¸ ì´ìœ ë„ ì—†ë‹¤. ë‚˜ëŠ” ì˜µì…˜ ì¤‘ì— `fields`, `type`, `name`, `references.table`, `references.field`ë¥¼ ì‚¬ìš©í–ˆë‹¤.

- `fields` : ë°°ì—´ í˜•íƒœì´ë©°, ì œì•½ì¡°ê±´ì„ ì ìš©í•  ì¹¼ëŸ¼ì´ë¦„ì´ë‹¤. 
- `type` : ì œì•½ì¡°ê±´ì„ ì ìš©í•  ì¹¼ëŸ¼ì´ë¦„ì˜ ìœ í˜•ì´ë‹¤. ì—¬ê¸°ì„œëŠ” ì™¸ë˜í‚¤ë¡œ ì ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— foreign keyë¥¼ ì ì–´ì¤¬ë‹¤.
- `name` : ì¹¼ëŸ¼ì— ì ìš©ë˜ëŠ” ì œì•½ì¡°ê±´ì˜ ì´ë¦„ì´ë‹¤. ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´, ì œì•½ì¡°ê±´ì˜ ìœ í˜•, í…Œì´ë¸” ë° ì—´ ì´ë¦„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë§Œë“ ë‹¤. (ì¤‘ë³µë˜ë©´ ì—ëŸ¬ë‚˜ë”ë¼...)
- `references` : ì™¸ë˜ í‚¤ë¥¼ ì—°ê²°í•  í…Œì´ë¸”ê³¼ ì¹¼ëŸ¼ì„ ì§€ì •í•˜ëŠ” ê°ì²´(Object)ì´ë‹¤. `table`ê³¼ `field`ë¼ëŠ” í‚¤ê°€ ìˆë‹¤. 
  - `table` : ì—°ê²°í•  í…Œì´ë¸”ì˜ ì´ë¦„
  - `field` : ì—°ê²°í•  ì¹¼ëŸ¼ì˜ ì´ë¦„

```js
onDelete: "cascade",
onUpdate: "cascade",
```

ìœ„ ì„¤ì •ì€ ì™¸ë˜í‚¤ë¥¼ ì„¤ì •í•  ë•Œ ê¼­ í•´ì¤˜ì•¼ í•œë‹¤. ê¼­, ê¼­.  `cascade` ëŠ” ë¶€ëª¨ í…Œì´ë¸”(ì—°ê²°í•  í…Œì´ë¸”)ì˜ ë°ì´í„°ë¥¼ ì œê±°í•˜ë©´ ê·¸ê²ƒê³¼ ì—°ê²°ëœ ìì‹(ì™¸ìºí‚¤ë¥¼ ê°€ì§„ í…Œì´ë¸”)í…Œì´ë¸”ì˜ í…Œì´í„°, ê·¸ ìì‹ì˜ ìì‹ê¹Œì§€ ëª¨ë“  ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì‚­ì œëœë‹¤.

<br>

# 2. MySQL í•œê¸€ ê¹¨ì§ ë¬¸ì œ(utf8)

APIë¥¼ ì™„ì„±í•˜ê³  ë°ì´í„°ë¥¼ ì´ê²ƒì €ê²ƒ ì§‘ì–´ë„£ë‹¤ê°€ í•œê¸€ì„ ë„£ìœ¼ë©´ ê¹¨ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.

```
Incorrect string value: '\xEB\x82\xB4\xEC\x9A\xA9...' for column 'content' at row 1 
```

ì •í™•íˆëŠ” ìœ„ì™€ ê°™ì€ ë¬¸ì œì¸ë°, ì˜ì–´ë¥¼ ì§‘ì–´ë„£ì„ ë•ŒëŠ” ë¬¸ì œê°€ ì—†ì´ ì‘ë™ëëŠ”ë° í•œê¸€ë§Œ ì§‘ì–´ë„£ìœ¼ë©´ ì˜¤ë¥˜ê°€ ìƒê²¼ë‹¤. ê²€ìƒ‰ì„ í•´ë³´ë‹ˆ DBì˜ ìºë¦­í„°ì…‹ì„ ë³€ê²½í•´ì•¼ í•œë‹¤.

sequelizesëŠ” defaultë¡œ utf8ì„ ìƒìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— stringìœ¼ë¡œ ì¹¼ëŸ¼ì„ ìƒì„±í•˜ë”ë¼ë„ utf8ì´ ì•„ë‹ˆë‹¤.

**/migrations/20210910065541-create-boards.js**

```js
'use strict';
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('Boards', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER
      },
      userId: {
        type: Sequelize.INTEGER,
        references: {
          model: 'Users',
          key: 'id',
          as: 'userId'
        }
      },
      title: {
        type: Sequelize.STRING
      },
      content: {
        type: Sequelize.STRING
      },
      like: {
        type: Sequelize.INTEGER,
        defaultValue:0
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE
      }
    },{
    charset: 'utf8',
    collate: 'utf8_unicode_ci',
    underscored: true,
 
    freezeTableName: true,
 
    tableName: 'Boards'
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Boards');
  }
};
```

í•´ì„œ ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ migrationsíŒŒì¼ì„ ìœ„ì²˜ëŸ¼ ìˆ˜ì •í•´ì¤¬ë‹¤.

```js
{
    charset: 'utf8',
    collate: 'utf8_unicode_ci',
    underscored: true,
 
    freezeTableName: true,
 
    tableName: 'Boards'
}
```

ìœ—ë¶€ë¶„ì„ ì¶”ê°€í•´ì¤Œìœ¼ë¡œì¨ Boards í…Œì´ë¸”ì˜ ëª¨ë“  ìºë¦­í„°ì…‹ì€ defaultë¡œ utf8ì´ ëœë‹¤.

<br>

# 3. ê³ ë¯¼ ì¤‘ì¸ ê²ƒ.

1:N ê´€ê³„ë¥¼ ì˜ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ `cascade`ë¥¼ ì„¤ì •í•´ì¤¬ë‹¤. ì´ê²Œ Workbenchì—ì„œëŠ” ì˜ ë³´ì´ëŠ”ë° ì •ë§ ì˜ ì„¤ì •ëëŠ”ì§€ëŠ” ëª¨ë¥´ê² ë‹¤. ëŒ“ê¸€ê¸°ëŠ¥ì„ ë„£ê¸° ì „ì— í™•ì¸í•´ë³´ê³ ì íšŒì›íƒˆí‡´ ê¸°ëŠ¥ì„ ì¶”ê°€í• ê¹Œ ê³ ë¯¼ ì¤‘ì´ë‹¤.
